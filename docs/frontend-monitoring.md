# 前端监控 (Frontend Monitoring)

前端监控（Frontend Monitoring）是确保 Web 应用稳定性、性能和用户体验的关键环节。在现代复杂的前端架构（如微服务、大模型应用）中，前端监控不仅仅是看页面有没有报错，更是一套全链路的感知系统。

前端监控通常被分为三大核心领域：**异常监控**、**性能监控**及**用户行为监控**。

## 1. 监控的三大维度

### 核心 1：异常监控 (Error Tracking)
实时捕获生产环境中的各种报错，防止“用户反馈了才发现问题”。

*   **JS 运行时错误**： 通过 `window.onerror` 或 `unhandledrejection` 捕获。
*   **资源加载错误**： 图片、脚本、样式表加载失败（404）。
*   **框架异常**： React 的 `ErrorBoundary` 或 Vue 的 `errorHandler`。
*   **白屏监控**： 通过检测关键 DOM 节点是否存在来判断页面是否渲染失败。

### 核心 2：性能监控 (Performance Monitoring)
利用浏览器提供的 Performance API 监控用户真实的加载体验。

*   **FP / FCP**： 白屏时间和首次内容绘制时间。
*   **LCP (Largest Contentful Paint)**： 最大内容渲染时间（衡量加载速度的核心指标）。
*   **FID (First Input Delay)**： 首次交互延迟（衡量响应速度）。
*   **CLS (Cumulative Layout Shift)**： 累计布局偏移（衡量视觉稳定性）。

### 核心 3：用户行为监控 (User Behavior)
了解用户在页面上做了什么，用于还原报错现场或产品决策。

*   **PV / UV**： 访问量与独立访客。
*   **用户路径**： 用户从 A 页面跳到 B 页面的轨迹。
*   **点击热力图**： 哪些按钮点击率高，哪些功能无人问津。
*   **错误录屏**： 通过 `rrweb` 等库记录错误发生前后的操作，像回放录像一样复现 Bug。

## 2. 前端监控系统的完整链路

一个成熟的监控系统通常遵循以下流程：

1.  **数据采集 (SDK)**： 在前端代码中集成轻量级 SDK，自动拦截异常和性能指标。
2.  **上报 (Reporting)**： 通常使用 `navigator.sendBeacon` 以不阻塞主线程的方式上报数据。
3.  **清洗与存储**： 后端处理原始数据，进行去重、聚合，存入 Elasticsearch 或 ClickHouse。
4.  **可视化平台**： 统计报表、错误堆栈解析（结合 SourceMap 将压缩的代码还原）。
5.  **告警 (Alerting)**： 错误频率超过阈值时，自动发送飞书/钉钉或邮件通知。

## 3. 主流技术选型

如果你的项目需要快速接入，可以考虑以下成熟方案：

| 类型 | 代表方案 | 优势 |
| :--- | :--- | :--- |
| **开源/自建** | **Sentry** | 行业标杆，支持全平台，SourceMap 解析强大。 |
| **SaaS 服务** | **阿里云 ARMS / 腾讯云 RUM** | 国内稳定，集成简单，性能指标分析透彻。 |
| **轻量级/自建** | **参考 Monitor (自建)** | 适合有特殊安全需求或想深度定制的团队。 |
| **用户录屏** | **LogRocket / rrweb** | 解决“无法复现”的终极神器。 |

## 4. 特殊场景：微前端监控

回到你之前提到的“前端微服务”，在微前端架构下监控会有一些挑战：

*   **错误归属**： 捕获到一个 JS 报错，需要通过 URL 或应用 ID 识别是基座还是哪个子应用抛出的。
*   **性能隔离**： 子应用的加载性能需要单独计算。
*   **沙箱环境**： 如果用了全局沙箱，`window.onerror` 可能失效，需要在沙箱层进行拦截。
